# All-Inkl optimierte .htaccess für Metropol Portal

# PHP Version - All-Inkl PHP 8.4
AddHandler application/x-httpd-php84 .php

# Rewrite Engine
RewriteEngine On

# Maintenance Mode
RewriteCond %{DOCUMENT_ROOT}/../storage/.maintenance -f
RewriteCond %{REQUEST_URI} !^/maintenance.html
RewriteRule ^.*$ /maintenance.html [L]

# HTTPS erzwingen
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]

# www entfernen
RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# Static Files direkt ausliefern
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^.*$ - [L]

# Alle anderen Anfragen an index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^.*$ index.php [L]

# Security Headers
<IfModule mod_headers.c>
    # HSTS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Content Security Policy - mit Google Maps API
    Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://maps.googleapis.com https://maps.gstatic.com https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://unpkg.com https://fonts.googleapis.com https://maps.googleapis.com; img-src 'self' data: https: blob:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://api.openrouteservice.org https://maps.googleapis.com https://nominatim.openstreetmap.org; frame-src https://maps.google.com"
    
    # Weitere Security Headers
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "DENY"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    Header set Feature-Policy "geolocation 'self'; microphone 'none'; camera 'none'"
    
    # Cache-Control für Static Assets
    <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|eot|svg)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
</IfModule>

# Kompression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/xml
</IfModule>

# ETags deaktivieren
FileETag None

# Directory Listing verbieten
Options -Indexes

# Zugriff auf sensible Dateien verbieten
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

<FilesMatch "\.(env|json|lock|md|yml|yaml|xml)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# PHP Einstellungen
<IfModule mod_php.c>
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
    php_value max_execution_time 30
    php_value max_input_time 30
    php_value memory_limit 128M
    php_flag display_errors Off
    php_flag log_errors On
    php_value error_log /w019e3c7/firmenpro.de/logs/php_errors.log
</IfModule>

# CORS Headers (nur für API)
<FilesMatch "^api/">
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
</FilesMatch>